<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Golf Package Auction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js';
        import { getDatabase, ref, onValue, set, push, get } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBIu34VQ9iwbuN4WWfH_VhoZyuVvvBFcjA",
            authDomain: "tphs-bidding.firebaseapp.com",
            databaseURL: "https://tphs-bidding-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tphs-bidding",
            storageBucket: "tphs-bidding.firebasestorage.app",
            messagingSenderId: "435837860397",
            appId: "1:435837860397:web:84a0807612ef18c67416a4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM elements
        const currentBidAmount = document.getElementById('currentBidAmount');
        const currentBidder = document.getElementById('currentBidder');
        const lastBidTime = document.getElementById('lastBidTime');
        const bidsTableBody = document.getElementById('bidsTableBody');
        const bidForm = document.getElementById('bidForm');
        const bidderNameInput = document.getElementById('bidderName');
        const bidAmountInput = document.getElementById('bidAmount');
        const toastContainer = document.getElementById('toastContainer');
        const clearDatabaseBtn = document.getElementById('clearDatabaseBtn');

        // Toast notification system
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-yellow-500';
            const textColor = type === 'success' ? 'text-white' : 'text-black';
            
            toast.className = `${bgColor} ${textColor} px-6 py-3 rounded-lg shadow-lg mb-2 transform transition-all duration-300 ease-in-out translate-x-full`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const time = date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            const dateStr = date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            return `${time}, ${dateStr}`;
        }

        // Update current bid display
        function updateCurrentBid(bidData) {
            console.log('updateCurrentBid called with:', bidData);
            if (bidData) {
                currentBidAmount.textContent = `$${bidData.amount.toLocaleString()}`;
                currentBidder.textContent = bidData.name;
                lastBidTime.textContent = formatTimestamp(bidData.timestamp);
                console.log('Updated current bid display');
            } else {
                currentBidAmount.textContent = '$0';
                currentBidder.textContent = 'No bids yet';
                lastBidTime.textContent = 'N/A';
                console.log('No bid data, showing default');
            }
        }

        // Update bids history table
        function updateBidsHistory(bidsData) {
            console.log('updateBidsHistory called with:', bidsData);
            bidsTableBody.innerHTML = '';
            
            if (!bidsData) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="3" class="text-center text-gray-500 py-4">No bids yet</td>';
                bidsTableBody.appendChild(row);
                console.log('No bids data, showing default');
                return;
            }

            // Convert to array and sort by timestamp (most recent first)
            const bidsArray = Object.entries(bidsData)
                .map(([key, value]) => ({ id: key, ...value }))
                .sort((a, b) => b.timestamp - a.timestamp);

            console.log('Bids array:', bidsArray);

            bidsArray.forEach(bid => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3 border-b">${bid.name}</td>
                    <td class="px-4 py-3 border-b font-semibold">$${bid.amount.toLocaleString()}</td>
                    <td class="px-4 py-3 border-b text-sm text-gray-600">${formatTimestamp(bid.timestamp)}</td>
                `;
                bidsTableBody.appendChild(row);
            });
            console.log('Updated bids history table');
        }

        // Set up real-time listeners
        const currentBidRef = ref(database, 'bids/current');
        const bidsHistoryRef = ref(database, 'bids/history');

        console.log('Setting up Firebase listeners...');
        console.log('Database URL:', firebaseConfig.databaseURL);

        onValue(currentBidRef, (snapshot) => {
            const data = snapshot.val();
            console.log('Current bid updated:', data);
            console.log('Snapshot exists:', snapshot.exists());
            console.log('Snapshot key:', snapshot.key);
            updateCurrentBid(data);
        }, (error) => {
            console.error('Error listening to current bid:', error);
        });

        onValue(bidsHistoryRef, (snapshot) => {
            const data = snapshot.val();
            console.log('Bids history updated:', data);
            console.log('History snapshot exists:', snapshot.exists());
            console.log('History snapshot key:', snapshot.key);
            updateBidsHistory(data);
        }, (error) => {
            console.error('Error listening to bids history:', error);
        });

        // Handle bid submission
        bidForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = bidderNameInput.value.trim();
            const amount = parseFloat(bidAmountInput.value);
            
            // Validate inputs
            if (!name) {
                showToast('‚ö†Ô∏è Please enter your name', 'warning');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('‚ö†Ô∏è Please enter a valid bid amount', 'warning');
                return;
            }
            
            try {
                // Get current highest bid
                const currentBidSnapshot = await get(currentBidRef);
                const currentBid = currentBidSnapshot.val();
                
                // Check if new bid is higher
                if (currentBid && amount <= currentBid.amount) {
                    showToast('‚ö†Ô∏è Bid must be higher than current bid', 'warning');
                    return;
                }
                
                // Create bid object
                const bidData = {
                    name: name,
                    amount: amount,
                    timestamp: Date.now()
                };
                
                // Update current highest bid
                await set(currentBidRef, bidData);
                
                // Add to history
                await push(bidsHistoryRef, bidData);
                
                // Show success message and clear form
                showToast('‚úÖ Bid placed successfully!', 'success');
                bidderNameInput.value = '';
                bidAmountInput.value = '';
                
            } catch (error) {
                console.error('Error placing bid:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                
                // Show detailed error message
                let errorMessage = '‚ùå Error placing bid. ';
                if (error.code) {
                    errorMessage += `Code: ${error.code}. `;
                }
                if (error.message) {
                    errorMessage += `Message: ${error.message}`;
                } else {
                    errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage, 'warning');
            }
        });

        // Clear database function
        async function clearDatabase() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear all bids? This cannot be undone!')) {
                try {
                    console.log('Clearing database...');
                    await set(currentBidRef, null);
                    await set(bidsHistoryRef, null);
                    showToast('üóëÔ∏è Database cleared successfully!', 'success');
                    console.log('Database cleared');
                } catch (error) {
                    console.error('Error clearing database:', error);
                    showToast('‚ùå Error clearing database', 'warning');
                }
            }
        }

        // Add event listener for clear database button
        if (clearDatabaseBtn) {
            clearDatabaseBtn.addEventListener('click', clearDatabase);
        }

        // Initialize display with current data
        get(currentBidRef).then((snapshot) => {
            updateCurrentBid(snapshot.val());
        });
        
        get(bidsHistoryRef).then((snapshot) => {
            updateBidsHistory(snapshot.val());
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 max-w-sm"></div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-gray-900 text-center">
                üèåÔ∏è‚Äç‚ôÇÔ∏è Staff Golf Package Auction
            </h1>
            <p class="text-lg text-gray-600 text-center mt-2">
                Place your bid below ‚Äî highest bid wins!
            </p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- Current Highest Bid Section -->
        <section class="bg-white rounded-lg shadow-md p-8 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">
                Current Highest Bid
            </h2>
            <div class="text-center">
                <div class="text-6xl font-bold text-green-600 mb-4" id="currentBidAmount">
                    $0
                </div>
                <div class="text-xl text-gray-700 mb-2" id="currentBidder">
                    No bids yet
                </div>
                <div class="text-sm text-gray-500" id="lastBidTime">
                    N/A
                </div>
            </div>
        </section>

        <!-- Recent Bids Table -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">
                Recent Bids
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left px-4 py-3 font-semibold text-gray-700">Name</th>
                            <th class="text-left px-4 py-3 font-semibold text-gray-700">Bid Amount</th>
                            <th class="text-left px-4 py-3 font-semibold text-gray-700">Time</th>
                        </tr>
                    </thead>
                    <tbody id="bidsTableBody">
                        <tr>
                            <td colspan="3" class="text-center text-gray-500 py-4">No bids yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Bid Form -->
        <section class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">
                    Place Your Bid
                </h2>
                <button 
                    id="clearDatabaseBtn"
                    type="button"
                    class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                >
                    üóëÔ∏è Clear Database
                </button>
            </div>
            <form id="bidForm" class="space-y-4">
                <div>
                    <label for="bidderName" class="block text-sm font-medium text-gray-700 mb-2">
                        Your Name
                    </label>
                    <input 
                        type="text" 
                        id="bidderName" 
                        name="bidderName"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                        placeholder="Enter your name"
                        required
                    >
                </div>
                <div>
                    <label for="bidAmount" class="block text-sm font-medium text-gray-700 mb-2">
                        Your Bid ($)
                    </label>
                    <input 
                        type="number" 
                        id="bidAmount" 
                        name="bidAmount"
                        step="0.01"
                        min="0"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                        placeholder="Enter your bid amount"
                        required
                    >
                </div>
                <button 
                    type="submit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                >
                    Place Bid
                </button>
            </form>
        </section>
    </main>
</body>
</html>
