<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Golf Package Auction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/countup@1.8.2/dist/countUp.min.js"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js';
        import { getDatabase, ref, onValue, set, push, get } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBIu34VQ9iwbuN4WWfH_VhoZyuVvvBFcjA",
            authDomain: "tphs-bidding.firebaseapp.com",
            databaseURL: "https://tphs-bidding-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tphs-bidding",
            storageBucket: "tphs-bidding.firebasestorage.app",
            messagingSenderId: "435837860397",
            appId: "1:435837860397:web:84a0807612ef18c67416a4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM elements
        const currentBidAmount = document.getElementById('currentBidAmount');
        const currentBidder = document.getElementById('currentBidder');
        const lastBidTime = document.getElementById('lastBidTime');
        const bidsTableBody = document.getElementById('bidsTableBody');
        const bidForm = document.getElementById('bidForm');
        const bidderNameInput = document.getElementById('bidderName');
        const bidAmountInput = document.getElementById('bidAmount');
        const toastContainer = document.getElementById('toastContainer');
        const clearDatabaseBtn = document.getElementById('clearDatabaseBtn');
        const aboutBtn = document.getElementById('aboutBtn');
        const aboutModal = document.getElementById('aboutModal');
        const closeAboutModal = document.getElementById('closeAboutModal');
        const closeAboutModalBtn = document.getElementById('closeAboutModalBtn');

        // CountUp instance for current bid
        let currentBidCountUp = null;
        
        // Countdown timer
        let countdownInterval = null;

        // Countdown functionality
        function startCountdown() {
            // Target date: Friday, October 24, 2025 at 3:00 PM
            const targetDate = new Date('2025-10-24T15:00:00');
            
            function updateCountdown() {
                const now = new Date();
                const timeLeft = targetDate - now;
                
                if (timeLeft <= 0) {
                    // Auction has ended
                    document.getElementById('countdownDisplay').innerHTML = `
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600 mb-2">‚è∞ Auction Ended</div>
                            <div class="text-sm text-gray-600">Bidding closed at 3:00 PM on October 24, 2025</div>
                        </div>
                    `;
                    
                    // Disable the bid form
                    const bidForm = document.getElementById('bidForm');
                    const formInputs = bidForm.querySelectorAll('input, button');
                    formInputs.forEach(input => {
                        input.disabled = true;
                        input.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                    
                    // Add a message above the form
                    const formSection = document.querySelector('section:first-of-type');
                    const endMessage = document.createElement('div');
                    endMessage.className = 'bg-red-50 border border-red-200 rounded-lg p-4 mb-4';
                    endMessage.innerHTML = `
                        <div class="flex items-center">
                            <div class="text-red-600 text-lg mr-2">üîí</div>
                            <div>
                                <div class="font-semibold text-red-800">Auction Closed</div>
                                <div class="text-sm text-red-600">Bidding has ended. No new bids will be accepted.</div>
                            </div>
                        </div>
                    `;
                    formSection.insertBefore(endMessage, bidForm);
                    
                    clearInterval(countdownInterval);
                    return;
                }
                
                // Calculate time components
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                // Format with leading zeros
                const daysStr = days.toString().padStart(2, '0');
                const hoursStr = hours.toString().padStart(2, '0');
                const minutesStr = minutes.toString().padStart(2, '0');
                const secondsStr = seconds.toString().padStart(2, '0');
                
                // Update display
                document.getElementById('countdownDisplay').innerHTML = `
                    <div class="text-center">
                        <div class="text-lg font-semibold text-gray-800 mb-2">‚è∞ Auction Ends In:</div>
                        <div class="text-4xl font-mono font-bold text-blue-600 mb-2">
                            ${daysStr}:${hoursStr}:${minutesStr}:${secondsStr}
                        </div>
                        <div class="text-sm text-gray-600">Friday, October 24, 2025 at 3:00 PM</div>
                    </div>
                `;
            }
            
            // Update immediately and then every second
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // Confetti function
        function triggerConfetti() {
            // Get the button position for confetti origin
            const button = document.querySelector('button[type="submit"]');
            const rect = button.getBoundingClientRect();
            const x = (rect.left + rect.right) / 2 / window.innerWidth;
            const y = (rect.top + rect.bottom) / 2 / window.innerHeight;

            // Create confetti burst
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { x: x, y: y },
                colors: ['#10b981', '#059669', '#047857', '#065f46', '#064e3b'], // Green theme
                shapes: ['star', 'circle'],
                scalar: 1.2
            });

            // Add a second burst for extra celebration
            setTimeout(() => {
                confetti({
                    particleCount: 50,
                    spread: 60,
                    origin: { x: x, y: y },
                    colors: ['#3b82f6', '#2563eb', '#1d4ed8', '#1e40af', '#1e3a8a'], // Blue theme
                    shapes: ['star', 'circle'],
                    scalar: 1.0
                });
            }, 200);
        }

        // Toast notification system
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-yellow-500';
            const textColor = type === 'success' ? 'text-white' : 'text-black';
            
            toast.className = `${bgColor} ${textColor} px-6 py-3 rounded-lg shadow-lg mb-2 transform transition-all duration-300 ease-in-out translate-x-full`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const time = date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            const dateStr = date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            return `${time}, ${dateStr}`;
        }

        // Update current bid display with CountUp animation
        function updateCurrentBid(bidData) {
            console.log('updateCurrentBid called with:', bidData);
            if (bidData && bidData.amount !== undefined && bidData.amount !== null) {
                // Update bidder and time immediately
                currentBidder.textContent = bidData.name;
                lastBidTime.textContent = formatTimestamp(bidData.timestamp);
                
                // Ensure we have a valid number
                const newAmount = parseFloat(bidData.amount);
                if (isNaN(newAmount)) {
                    console.error('Invalid amount:', bidData.amount);
                    currentBidAmount.textContent = '0';
                    return;
                }
                
                const currentAmount = currentBidCountUp ? currentBidCountUp.endVal : 0;
                
                if (currentBidCountUp && newAmount !== currentAmount) {
                    // Update existing CountUp instance
                    currentBidCountUp.update(newAmount);
                } else if (!currentBidCountUp) {
                    // Create new CountUp instance - note: CountUp constructor is (element_id, startVal, endVal, decimals, duration, options)
                    const options = {
                        prefix: '$',
                        separator: ',',
                        decimal: '.',
                        useEasing: true,
                        useGrouping: true
                    };
                    currentBidCountUp = new CountUp('currentBidAmount', 0, newAmount, 0, 1.5, options);
                    currentBidCountUp.start();
                }
                
                console.log('Updated current bid display with animation to:', newAmount);
            } else {
                // Reset to default state
                if (currentBidCountUp) {
                    currentBidCountUp.update(0);
                } else {
                    currentBidAmount.textContent = '0';
                }
                currentBidder.textContent = 'No bids yet';
                lastBidTime.textContent = 'N/A';
                console.log('No bid data, showing default');
            }
        }

        // Update bids history table
        function updateBidsHistory(bidsData) {
            console.log('updateBidsHistory called with:', bidsData);
            bidsTableBody.innerHTML = '';
            
            if (!bidsData) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="3" class="text-center text-gray-500 py-4">No bids yet</td>';
                bidsTableBody.appendChild(row);
                console.log('No bids data, showing default');
                return;
            }

            // Convert to array and sort by timestamp (most recent first)
            const bidsArray = Object.entries(bidsData)
                .map(([key, value]) => ({ id: key, ...value }))
                .sort((a, b) => b.timestamp - a.timestamp);

            console.log('Bids array:', bidsArray);

            bidsArray.forEach(bid => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3 border-b">${bid.name}</td>
                    <td class="px-4 py-3 border-b font-semibold text-right">$${bid.amount.toLocaleString()}</td>
                    <td class="px-4 py-3 border-b text-sm text-gray-600">${formatTimestamp(bid.timestamp)}</td>
                `;
                bidsTableBody.appendChild(row);
            });
            console.log('Updated bids history table');
        }

        // Set up real-time listeners
        const currentBidRef = ref(database, 'bids/current');
        const bidsHistoryRef = ref(database, 'bids/history');

        console.log('Setting up Firebase listeners...');
        console.log('Database URL:', firebaseConfig.databaseURL);

        onValue(currentBidRef, (snapshot) => {
            const data = snapshot.val();
            console.log('Current bid updated:', data);
            console.log('Snapshot exists:', snapshot.exists());
            console.log('Snapshot key:', snapshot.key);
            updateCurrentBid(data);
        }, (error) => {
            console.error('Error listening to current bid:', error);
        });

        onValue(bidsHistoryRef, (snapshot) => {
            const data = snapshot.val();
            console.log('Bids history updated:', data);
            console.log('History snapshot exists:', snapshot.exists());
            console.log('History snapshot key:', snapshot.key);
            updateBidsHistory(data);
        }, (error) => {
            console.error('Error listening to bids history:', error);
        });

        // Handle bid submission
        bidForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check if auction has ended
            const targetDate = new Date('2025-10-24T15:00:00');
            if (new Date() >= targetDate) {
                showToast('‚ö†Ô∏è Auction has ended. No new bids are accepted.', 'warning');
                return;
            }
            
            const name = bidderNameInput.value.trim();
            const amount = parseFloat(bidAmountInput.value);
            
            // Validate inputs
            if (!name) {
                showToast('‚ö†Ô∏è Please enter your name', 'warning');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('‚ö†Ô∏è Please enter a valid bid amount', 'warning');
                return;
            }
            
            try {
                // Get current highest bid
                const currentBidSnapshot = await get(currentBidRef);
                const currentBid = currentBidSnapshot.val();
                
                // Check if new bid is higher
                if (currentBid && amount <= currentBid.amount) {
                    showToast('‚ö†Ô∏è Bid must be higher than current bid', 'warning');
                    return;
                }
                
                // Create bid object
                const bidData = {
                    name: name,
                    amount: amount,
                    timestamp: Date.now()
                };
                
                // Update current highest bid
                await set(currentBidRef, bidData);
                
                // Add to history
                await push(bidsHistoryRef, bidData);
                
                // Show success message, trigger confetti, and clear form
                showToast('‚úÖ Bid placed successfully!', 'success');
                triggerConfetti();
                bidderNameInput.value = '';
                bidAmountInput.value = '';
                
            } catch (error) {
                console.error('Error placing bid:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                
                // Show detailed error message
                let errorMessage = '‚ùå Error placing bid. ';
                if (error.code) {
                    errorMessage += `Code: ${error.code}. `;
                }
                if (error.message) {
                    errorMessage += `Message: ${error.message}`;
                } else {
                    errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage, 'warning');
            }
        });

        // Clear database function
        async function clearDatabase() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear all bids? This cannot be undone!')) {
                try {
                    console.log('Clearing database...');
                    await set(currentBidRef, null);
                    await set(bidsHistoryRef, null);
                    showToast('üóëÔ∏è Database cleared successfully!', 'success');
                    console.log('Database cleared');
                } catch (error) {
                    console.error('Error clearing database:', error);
                    showToast('‚ùå Error clearing database', 'warning');
                }
            }
        }

        // Add event listener for clear database button
        if (clearDatabaseBtn) {
            clearDatabaseBtn.addEventListener('click', clearDatabase);
        }

        // Modal functions
        function openAboutModal() {
            aboutModal.classList.remove('hidden');
        }

        function closeAboutModalFunc() {
            aboutModal.classList.add('hidden');
        }

        // Add event listeners for about modal
        if (aboutBtn) {
            aboutBtn.addEventListener('click', openAboutModal);
        }

        if (closeAboutModal) {
            closeAboutModal.addEventListener('click', closeAboutModalFunc);
        }

        if (closeAboutModalBtn) {
            closeAboutModalBtn.addEventListener('click', closeAboutModalFunc);
        }

        // Close modal when clicking outside
        if (aboutModal) {
            aboutModal.addEventListener('click', (e) => {
                if (e.target === aboutModal) {
                    closeAboutModalFunc();
                }
            });
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !aboutModal.classList.contains('hidden')) {
                closeAboutModalFunc();
            }
        });

        // Initialize display with current data
        get(currentBidRef).then((snapshot) => {
            updateCurrentBid(snapshot.val());
        });
        
        get(bidsHistoryRef).then((snapshot) => {
            updateBidsHistory(snapshot.val());
        });

        // Start the countdown timer
        startCountdown();
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 max-w-sm"></div>

    <!-- About Modal -->
    <div id="aboutModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-96 overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">üèåÔ∏è‚Äç‚ôÇÔ∏è About the Auction</h3>
                        <button id="closeAboutModal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                            √ó
                        </button>
                    </div>
                    <div class="space-y-4 text-gray-700">
                        <p class="font-medium">Staff Golf Package Live Auction</p>
                        <p>This is a real-time auction system for internal staff bidding on a golf package.</p>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <h4 class="font-semibold text-green-800 mb-2">üèÜ What You're Bidding On:</h4>
                            <p class="text-sm text-gray-700">
                                <strong>Te Puke Golf Club Voucher</strong><br>
                                ‚Ä¢ 4 Players √ó 18 Holes<br>
                                ‚Ä¢ 2 Golf Carts included<br>
                                ‚Ä¢ Perfect for a day out with colleagues or friends!
                            </p>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">How it works:</h4>
                            <ul class="list-disc list-inside space-y-1 text-sm">
                                <li>Enter your name and bid amount</li>
                                <li>Click "Place Bid" to submit</li>
                                <li>Watch live updates as others bid</li>
                                <li>Highest bid when countdown ends wins!</li>
                            </ul>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Features:</h4>
                            <ul class="list-disc list-inside space-y-1 text-sm">
                                <li>Real-time bid updates across all users</li>
                                <li>Bid validation (must be higher than current)</li>
                                <li>Live countdown to auction end</li>
                                <li>Automatic form closure when time expires</li>
                            </ul>
                        </div>

                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <strong>Note:</strong> All bids are final. Make sure you're ready to pay your bid amount if you win!
                            </p>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="closeAboutModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Got it!
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-gray-900 text-center">
                üèåÔ∏è‚Äç‚ôÇÔ∏è Staff Golf Package Auction
            </h1>
            <p class="text-sm text-gray-600 text-center mt-1">
                Te Puke Golf Club: 4 Players √ó 18 Holes + 2 Golf Carts ‚Ä¢ Place your bid below ‚Äî highest bid wins!
            </p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- Countdown Timer Section -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div id="countdownDisplay">
                <!-- Countdown will be inserted here -->
            </div>
        </section>

        <!-- Bid Form Section -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">
                    Place Your Bid
                </h2>
                <div class="flex gap-2">
                    <button 
                        id="aboutBtn"
                        type="button"
                        class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    >
                        ‚ÑπÔ∏è About
                    </button>
                    <button 
                        id="clearDatabaseBtn"
                        type="button"
                        class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                    >
                        üóëÔ∏è Clear
                    </button>
                </div>
            </div>
            <form id="bidForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="bidderName" class="block text-sm font-medium text-gray-700 mb-2">
                        Your Name
                    </label>
                    <input 
                        type="text" 
                        id="bidderName" 
                        name="bidderName"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                        placeholder="Enter your name"
                        required
                    >
                </div>
                <div>
                    <label for="bidAmount" class="block text-sm font-medium text-gray-700 mb-2">
                        Your Bid ($)
                    </label>
                    <input 
                        type="number" 
                        id="bidAmount" 
                        name="bidAmount"
                        step="0.01"
                        min="0"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-colors"
                        placeholder="Enter your bid amount"
                        required
                    >
                </div>
                <div class="flex items-end">
                    <button 
                        type="submit"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                    >
                        Place Bid
                    </button>
                </div>
            </form>
        </section>

        <!-- Current Highest Bid Section -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">
                        Current Highest Bid
                    </h2>
                    <div class="text-4xl font-bold text-green-600" id="currentBidAmount">
                        0
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg text-gray-700" id="currentBidder">
                        No bids yet
                    </div>
                    <div class="text-sm text-gray-500" id="lastBidTime">
                        N/A
                    </div>
                </div>
            </div>
        </section>

        <!-- Recent Bids Section -->
        <section class="bg-white rounded-lg shadow-md p-6 flex-1">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">
                Recent Bids
            </h2>
            <div class="overflow-y-auto max-h-96">
                <table class="w-full">
                    <thead class="sticky top-0 bg-white">
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left px-4 py-3 font-semibold text-gray-700">Name</th>
                            <th class="text-right px-4 py-3 font-semibold text-gray-700">Bid Amount</th>
                            <th class="text-left px-4 py-3 font-semibold text-gray-700">Time</th>
                        </tr>
                    </thead>
                    <tbody id="bidsTableBody">
                        <tr>
                            <td colspan="3" class="text-center text-gray-500 py-4">No bids yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>
</body>
</html>
